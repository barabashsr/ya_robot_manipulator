<story-context id="1-3-define-service-and-message-interfaces" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Define Service and Message Interfaces</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-define-service-and-message-interfaces.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>all service (.srv) and message (.msg) interface definitions created in the manipulator_control package</iWant>
    <soThat>I can implement service servers and use custom message types in subsequent epics</soThat>
    <tasks>
      <task id="1" ac="1,3,8">Create Service Definitions
        <subtask id="1.1">Create GetAddressCoordinates.srv - resolve warehouse address to pose</subtask>
        <subtask id="1.2">Create ToggleElectromagnet.srv - activate/deactivate magnet</subtask>
        <subtask id="1.3">Create SpawnBox.srv - spawn box in Gazebo at address</subtask>
        <subtask id="1.4">Create DespawnBox.srv - remove box from Gazebo</subtask>
        <subtask id="1.5">Create ValidateAddress.srv - validate address and check occupancy</subtask>
      </task>
      <task id="2" ac="2,8">Create Message Definitions
        <subtask id="2.1">Create Address.msg - warehouse address (side, cabinet, row, column)</subtask>
        <subtask id="2.2">Create JointCommand.msg - joint position command</subtask>
        <subtask id="2.3">Create LimitSwitchState.msg - limit switch status</subtask>
      </task>
      <task id="3" ac="4">Update CMakeLists.txt for Interface Generation
        <subtask id="3.1">Add all 5 srv files to rosidl_generate_interfaces</subtask>
        <subtask id="3.2">Add all 3 msg files to rosidl_generate_interfaces</subtask>
        <subtask id="3.3">Ensure DEPENDENCIES includes geometry_msgs</subtask>
      </task>
      <task id="4" ac="5,6,7">Validate Build and Interface Generation
        <subtask id="4.1">Run colcon build --packages-select manipulator_control</subtask>
        <subtask id="4.2">Verify exit code 0, no errors, no warnings</subtask>
        <subtask id="4.3">Test Python srv imports</subtask>
        <subtask id="4.4">Test Python msg imports</subtask>
        <subtask id="4.5">Verify C++ headers generated</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">5 service files exist in ros2_ws/src/manipulator_control/srv/ directory</ac>
    <ac id="2">3 message files exist in ros2_ws/src/manipulator_control/msg/ directory</ac>
    <ac id="3">Each service file has properly defined Request and Response sections</ac>
    <ac id="4">CMakeLists.txt updated with rosidl_generate_interfaces for all srv and msg files</ac>
    <ac id="5">colcon build --packages-select manipulator_control exits with code 0, no errors, no warnings</ac>
    <ac id="6">Python interfaces importable: from manipulator_control.srv import GetAddressCoordinates, ...</ac>
    <ac id="7">Python interfaces importable: from manipulator_control.msg import Address, JointCommand, LimitSwitchState</ac>
    <ac id="8">Each interface file includes comments explaining fields</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Custom Message Types (Lines 80-103)</section>
        <snippet>Address.msg (side, cabinet_num, row, column), JointCommand.msg (joint_name, target_position, max_velocity), LimitSwitchState.msg (switch_name, triggered, trigger_position, current_position).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Service Definitions (Lines 355-424)</section>
        <snippet>5 services: GetAddressCoordinates (uses geometry_msgs/Pose), ToggleElectromagnet, SpawnBox, DespawnBox, ValidateAddress.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-2-define-all-action-interfaces.md</path>
        <title>Story 1.2 - Previous Story</title>
        <section>Dev Agent Record</section>
        <snippet>CMakeLists.txt rosidl_generate_interfaces pattern established. Build time ~21.6s. geometry_msgs DEPENDENCIES already included.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>ros2_ws/src/manipulator_control/CMakeLists.txt</path>
        <kind>build-config</kind>
        <symbol>CMakeLists.txt</symbol>
        <reason>Must add srv and msg files to existing rosidl_generate_interfaces block</reason>
      </file>
      <file>
        <path>ros2_ws/src/manipulator_control/srv/.gitkeep</path>
        <kind>placeholder</kind>
        <symbol>.gitkeep</symbol>
        <reason>Service directory exists, remove .gitkeep after adding srv files</reason>
      </file>
      <file>
        <path>ros2_ws/src/manipulator_control/msg/.gitkeep</path>
        <kind>placeholder</kind>
        <symbol>.gitkeep</symbol>
        <reason>Message directory exists, remove .gitkeep after adding msg files</reason>
      </file>
    </code>
    <dependencies>
      <ros2>
        <pkg>geometry_msgs</pkg>
        <pkg>rosidl_default_generators</pkg>
        <pkg>rosidl_default_runtime</pkg>
        <pkg>std_srvs</pkg>
      </ros2>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="format">Each .srv file must have Request and Response sections separated by ---</constraint>
    <constraint type="format">Each .msg file defines fields with type and name</constraint>
    <constraint type="dependency">GetAddressCoordinates.srv uses geometry_msgs/Pose - already in DEPENDENCIES</constraint>
    <constraint type="standard">Follow exact interface definitions from tech-spec-epic-1.md</constraint>
    <constraint type="documentation">Include field comments for each interface explaining purpose</constraint>
    <constraint type="compatibility">ROS2 Jazzy + Gazebo Harmonic</constraint>
  </constraints>

  <interfaces>
    <service name="GetAddressCoordinates.srv">
      <request>string side, uint8 cabinet_num, uint8 row, uint8 column</request>
      <response>bool success, geometry_msgs/Pose pose, string error_message</response>
    </service>
    <service name="ToggleElectromagnet.srv">
      <request>bool activate</request>
      <response>bool success, bool magnet_engaged, string message</response>
    </service>
    <service name="SpawnBox.srv">
      <request>string box_id, string side, uint8 cabinet_num, uint8 row, uint8 column</request>
      <response>bool success, string box_id, uint8 department_count, string message</response>
    </service>
    <service name="DespawnBox.srv">
      <request>string box_id</request>
      <response>bool success, string message</response>
    </service>
    <service name="ValidateAddress.srv">
      <request>string side, uint8 cabinet_num, uint8 row, uint8 column, bool check_empty, bool check_width_match, uint8 box_width</request>
      <response>bool valid, bool is_empty, bool width_compatible, string error_message</response>
    </service>
    <message name="Address.msg">
      <fields>string side, uint8 cabinet_num, uint8 row, uint8 column</fields>
    </message>
    <message name="JointCommand.msg">
      <fields>string joint_name, float64 target_position, float64 max_velocity</fields>
    </message>
    <message name="LimitSwitchState.msg">
      <fields>string switch_name, bool triggered, float64 trigger_position, float64 current_position</fields>
    </message>
  </interfaces>

  <tests>
    <standards>Build verification + interface import tests. Run colcon build, verify Python srv/msg imports, check C++ header generation. Complete interface test validates all 20 interfaces (12 actions + 5 services + 3 messages).</standards>
    <locations>
      <location>ros2_ws/src/manipulator_control/srv/</location>
      <location>ros2_ws/src/manipulator_control/msg/</location>
      <location>install/manipulator_control/include/</location>
    </locations>
    <ideas>
      <idea ac="5">colcon build --packages-select manipulator_control exits 0, no errors/warnings</idea>
      <idea ac="6">python3 -c "from manipulator_control.srv import GetAddressCoordinates" succeeds</idea>
      <idea ac="6">python3 -c "from manipulator_control.srv import ValidateAddress" succeeds</idea>
      <idea ac="7">python3 -c "from manipulator_control.msg import Address" succeeds</idea>
      <idea ac="7">python3 -c "from manipulator_control.msg import LimitSwitchState" succeeds</idea>
      <idea ac="1">ls ros2_ws/src/manipulator_control/srv/*.srv | wc -l equals 5</idea>
      <idea ac="2">ls ros2_ws/src/manipulator_control/msg/*.msg | wc -l equals 3</idea>
    </ideas>
  </tests>

  <previousStoryLearnings>
    <story key="1-1-create-ros2-package-structure" status="review">
      <newFiles>
        <file>ros2_ws/src/manipulator_control/CMakeLists.txt</file>
        <file>ros2_ws/src/manipulator_control/package.xml</file>
        <file>ros2_ws/src/manipulator_control/srv/.gitkeep</file>
        <file>ros2_ws/src/manipulator_control/msg/.gitkeep</file>
      </newFiles>
      <architecturalDecisions>
        <decision>ros2_control package removed - not available as package</decision>
      </architecturalDecisions>
    </story>
    <story key="1-2-define-all-action-interfaces" status="review">
      <newFiles>
        <file>ros2_ws/src/manipulator_control/action/*.action (12 files)</file>
      </newFiles>
      <modifiedFiles>
        <file>ros2_ws/src/manipulator_control/CMakeLists.txt</file>
      </modifiedFiles>
      <architecturalDecisions>
        <decision>rosidl_generate_interfaces block with geometry_msgs DEPENDENCIES established</decision>
      </architecturalDecisions>
      <warningsForNext>
        <warning>Add srv and msg files to existing rosidl_generate_interfaces block - do not create new block</warning>
      </warningsForNext>
    </story>
  </previousStoryLearnings>
</story-context>
