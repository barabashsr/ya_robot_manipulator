<story-context id="2-1-implement-virtual-limit-switch-simulation" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Implement Virtual Limit Switch Simulation</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-implement-virtual-limit-switch-simulation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to simulate all 18 limit switches (2 per joint) in Gazebo</iWant>
    <soThat>picker state machine and safety monitoring can operate without physical hardware</soThat>
    <tasks>
      <task id="1" ac="4,6">Create Configuration File
        <subtask id="1.1">Create config/limit_switches.yaml with all 18 switch definitions</subtask>
        <subtask id="1.2">Define trigger_position and trigger_tolerance for each switch</subtask>
        <subtask id="1.3">Set publish_rate to 10.0 Hz</subtask>
        <subtask id="1.4">Use joint limits from ros2_control.xacro as reference</subtask>
      </task>
      <task id="2" ac="1,2,3,5">Implement VirtualLimitSwitchNode
        <subtask id="2.1">Create src/virtual_limit_switches.py</subtask>
        <subtask id="2.2">Subscribe to /joint_states topic</subtask>
        <subtask id="2.3">Load configuration from limit_switches.yaml</subtask>
        <subtask id="2.4">Create 18 Bool publishers for each switch topic</subtask>
        <subtask id="2.5">Implement joint_state_callback to check positions against thresholds</subtask>
        <subtask id="2.6">Publish switch states at configured rate (10 Hz)</subtask>
      </task>
      <task id="3" ac="7">Create Launch File
        <subtask id="3.1">Create launch/virtual_limit_switches.launch.py</subtask>
        <subtask id="3.2">Configure node to load config from package share directory</subtask>
        <subtask id="3.3">Add parameters for config file path</subtask>
      </task>
      <task id="4" ac="1">Update Package Configuration
        <subtask id="4.1">Update CMakeLists.txt to install config/ and launch/ directories</subtask>
        <subtask id="4.2">Update CMakeLists.txt to install Python scripts to lib/</subtask>
        <subtask id="4.3">Rebuild package</subtask>
      </task>
      <task id="5" ac="2,3,8">Validate Implementation
        <subtask id="5.1">Launch Gazebo simulation</subtask>
        <subtask id="5.2">Launch virtual_limit_switches node</subtask>
        <subtask id="5.3">Verify all 18 topics exist with ros2 topic list</subtask>
        <subtask id="5.4">Move joints to limits and verify switch state changes</subtask>
        <subtask id="5.5">Verify publish rate is 10 Hz</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">VirtualLimitSwitchNode exists at ros2_ws/src/manipulator_control/src/virtual_limit_switches.py</ac>
    <ac id="2">Node publishes boolean states for all 18 switches at 10 Hz to /manipulator/end_switches/* topics</ac>
    <ac id="3">Switch states transition to TRUE when joint position reaches trigger threshold (within tolerance)</ac>
    <ac id="4">Switch trigger positions are loaded from config/limit_switches.yaml</ac>
    <ac id="5">Node subscribes to /joint_states to monitor all 9 joint positions</ac>
    <ac id="6">Configuration file defines trigger_position and trigger_tolerance for each of 18 switches</ac>
    <ac id="7">Launch file exists to start the node: launch/virtual_limit_switches.launch.py</ac>
    <ac id="8">All 18 topics verified publishing with ros2 topic list and state changes verified</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Configuration Files - limit_switches.yaml</section>
        <snippet>Complete limit switch configuration with trigger_position, trigger_tolerance, and publish_rate for all 18 switches across 9 joints.</snippet>
      </doc>
      <doc>
        <path>docs/architecture-ros2-control-v2-CORRECTIONS.md</path>
        <title>ROS2 Control Architecture v2.0</title>
        <section>Virtual Limit Switches (Lines 247-306)</section>
        <snippet>VirtualLimitSwitchNode implementation pattern: subscribe to /joint_states, publish Bool to /manipulator/end_switches/*, load config from YAML.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Story 2.1</section>
        <snippet>Simulate 18 limit switches (2 per joint). Picker state machine uses switches for OPEN_JAW, EXTEND, CLOSE, RETRACT state transitions.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>ros2_ws/src/manipulator_control/CMakeLists.txt</path>
        <kind>build-config</kind>
        <symbol>CMakeLists.txt</symbol>
        <reason>Must update to install config/, launch/, and Python scripts</reason>
      </file>
      <file>
        <path>ros2_ws/src/manipulator_control/config/.gitkeep</path>
        <kind>placeholder</kind>
        <symbol>.gitkeep</symbol>
        <reason>Config directory exists, add limit_switches.yaml here</reason>
      </file>
      <file>
        <path>ros2_ws/src/manipulator_control/launch/.gitkeep</path>
        <kind>placeholder</kind>
        <symbol>.gitkeep</symbol>
        <reason>Launch directory exists, add launch file here</reason>
      </file>
      <file>
        <path>ros2_ws/src/manipulator_description/config/manipulator_controllers.yaml</path>
        <kind>config</kind>
        <symbol>controller config</symbol>
        <reason>Reference for joint names and controller topics</reason>
      </file>
      <file>
        <path>ros2_ws/src/manipulator_description/urdf/manipulator/ros2_control.xacro</path>
        <kind>urdf</kind>
        <symbol>ros2_control.xacro</symbol>
        <reason>Contains joint limits (min/max) to set trigger positions</reason>
      </file>
    </code>
    <dependencies>
      <ros2>
        <pkg>rclpy</pkg>
        <pkg>std_msgs</pkg>
        <pkg>sensor_msgs</pkg>
        <pkg>launch</pkg>
        <pkg>launch_ros</pkg>
        <pkg>ament_index_python</pkg>
      </ros2>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="rate">Publish rate must be 10 Hz minimum for picker state machine responsiveness</constraint>
    <constraint type="topic">All topics under /manipulator/end_switches/ namespace</constraint>
    <constraint type="message">Use std_msgs/Bool for switch states (simple, efficient)</constraint>
    <constraint type="tolerance">Default trigger tolerance: 0.01m</constraint>
    <constraint type="compatibility">ROS2 Jazzy + Gazebo Harmonic</constraint>
  </constraints>

  <interfaces>
    <!-- CORRECTED switch names - use semantic naming from limit_switches.yaml -->
    <topic name="/manipulator/end_switches/base_main_frame_min" type="std_msgs/Bool" note="X=0.01"/>
    <topic name="/manipulator/end_switches/base_main_frame_max" type="std_msgs/Bool" note="X=3.9"/>
    <topic name="/manipulator/end_switches/selector_frame_min" type="std_msgs/Bool" note="Z=0.005"/>
    <topic name="/manipulator/end_switches/selector_frame_max" type="std_msgs/Bool" note="Z=1.90"/>
    <!-- Gripper: LEFT/RIGHT semantics, NOT extend/retract -->
    <topic name="/manipulator/end_switches/gripper_right" type="std_msgs/Bool" note="Y=-0.39 toward RIGHT cabinets"/>
    <topic name="/manipulator/end_switches/gripper_left" type="std_msgs/Bool" note="Y=+0.39 toward LEFT cabinets"/>
    <topic name="/manipulator/end_switches/picker_frame_min" type="std_msgs/Bool" note="Z=0.005"/>
    <topic name="/manipulator/end_switches/picker_frame_max" type="std_msgs/Bool" note="Z=0.295"/>
    <topic name="/manipulator/end_switches/picker_rail_min" type="std_msgs/Bool" note="Y=-0.29"/>
    <topic name="/manipulator/end_switches/picker_rail_max" type="std_msgs/Bool" note="Y=+0.29"/>
    <!-- Picker extension: retracted/extended semantics, NOT picker_base_min/max -->
    <topic name="/manipulator/end_switches/picker_retracted" type="std_msgs/Bool" note="X=0.01 home position"/>
    <topic name="/manipulator/end_switches/picker_extended" type="std_msgs/Bool" note="X=0.24 over container"/>
    <topic name="/manipulator/end_switches/picker_jaw_opened" type="std_msgs/Bool" note="X=0.19"/>
    <topic name="/manipulator/end_switches/picker_jaw_closed" type="std_msgs/Bool" note="X=0.01"/>
    <topic name="/manipulator/end_switches/container_left_min" type="std_msgs/Bool"/>
    <topic name="/manipulator/end_switches/container_left_max" type="std_msgs/Bool"/>
    <topic name="/manipulator/end_switches/container_right_min" type="std_msgs/Bool"/>
    <topic name="/manipulator/end_switches/container_right_max" type="std_msgs/Bool"/>
    <subscription name="/joint_states" type="sensor_msgs/JointState"/>
  </interfaces>

  <tests>
    <standards>Build verification + runtime tests. Verify 18 topics exist, publish at 10 Hz, and state changes when joints move to limits.</standards>
    <locations>
      <location>ros2_ws/src/manipulator_control/src/</location>
      <location>ros2_ws/src/manipulator_control/config/</location>
      <location>ros2_ws/src/manipulator_control/launch/</location>
    </locations>
    <ideas>
      <idea ac="8">ros2 topic list | grep end_switches | wc -l equals 18</idea>
      <idea ac="2">ros2 topic hz /manipulator/end_switches/picker_jaw_closed shows ~10 Hz</idea>
      <idea ac="3">Move picker jaw to 0.19, verify picker_jaw_closed is true</idea>
      <idea ac="3">Move picker jaw to 0.01, verify picker_jaw_opened is true</idea>
      <idea ac="5">Node logs joint positions from /joint_states subscription</idea>
    </ideas>
  </tests>

  <previousStoryLearnings>
    <epic key="epic-1" status="done">
      <summary>All 20 interfaces created (12 actions + 5 services + 3 messages). LimitSwitchState.msg available for future use.</summary>
      <newFiles>
        <file>ros2_ws/src/manipulator_control/msg/LimitSwitchState.msg</file>
      </newFiles>
      <architecturalDecisions>
        <decision>ros2_control package not available - use controller_manager, controller_interface, ros2_controllers</decision>
        <decision>CMakeLists.txt uses rosidl_generate_interfaces for interface generation</decision>
      </architecturalDecisions>
    </epic>
  </previousStoryLearnings>

  <jointLimitsReference>
    <note>Extract trigger positions from ros2_control.xacro joint limits</note>
    <joint name="base_main_frame_joint" min="0.0" max="3.0" note="X-axis railway"/>
    <joint name="main_frame_selector_frame_joint" min="0.0" max="1.1" note="Z-axis vertical"/>
    <joint name="selector_frame_gripper_joint" min="0.0" max="0.6" note="Gripper Y-axis"/>
    <joint name="selector_frame_picker_frame_joint" min="0.0" max="0.3" note="Picker Z-axis"/>
    <joint name="picker_frame_picker_rail_joint" min="0.0" max="0.2" note="Picker Y-axis"/>
    <joint name="picker_rail_picker_base_joint" min="0.0" max="0.12" note="Picker X-axis extension"/>
    <joint name="picker_base_picker_jaw_joint" min="0.0" max="0.2" note="Picker jaw"/>
    <joint name="selector_left_container_jaw_joint" min="-0.1" max="0.1" note="Container left jaw"/>
    <joint name="selector_right_container_jaw_joint" min="-0.1" max="0.1" note="Container right jaw"/>
  </jointLimitsReference>
</story-context>
